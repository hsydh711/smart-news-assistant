# æ™ºèƒ½æ–°é—»åŠ©æ‰‹ - åç«¯æœåŠ¡éƒ¨ç½²æŒ‡å—

## é—®é¢˜è¯´æ˜

ä¹‹å‰çš„HTMLç‰ˆæœ¬ç›´æ¥è°ƒç”¨Coze APIå¯¼è‡´CORSè·¨åŸŸé—®é¢˜ã€‚ç°åœ¨å·²ç»åˆ›å»ºäº†åç«¯APIä»£ç†æœåŠ¡ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

## æ¶æ„è¯´æ˜

```
å‰ç«¯ï¼ˆHTMLï¼‰ â†’ åç«¯APIä»£ç† â†’ LangChain Agent â†’ CozeæœåŠ¡
```

- **å‰ç«¯**ï¼šç”¨æˆ·ç•Œé¢ï¼Œè¿è¡Œåœ¨æµè§ˆå™¨ä¸­
- **åç«¯APIä»£ç†**ï¼šFlaskæœåŠ¡ï¼Œå¤„ç†HTTPè¯·æ±‚ï¼Œè°ƒç”¨Agent
- **LangChain Agent**ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œè°ƒç”¨LLMå’Œå·¥å…·
- **CozeæœåŠ¡**ï¼šæä¾›å¤§è¯­è¨€æ¨¡å‹å’Œç”Ÿå›¾æœåŠ¡

## å¿«é€Ÿéƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šRenderï¼ˆæ¨èï¼Œå…è´¹ï¼‰

Renderæä¾›å…è´¹çš„æœåŠ¡å™¨æ‰˜ç®¡ï¼Œéå¸¸é€‚åˆéƒ¨ç½²Flaskåº”ç”¨ã€‚

#### æ­¥éª¤ï¼š

1. **åˆ›å»ºRenderè´¦å·**
   - è®¿é—® https://render.com
   - æ³¨å†Œè´¦å·ï¼ˆå»ºè®®ä½¿ç”¨GitHubç™»å½•ï¼‰

2. **åˆ›å»ºæ–°æœåŠ¡**
   - ç‚¹å‡» "New +"
   - é€‰æ‹© "Web Service"
   - è¿æ¥ä½ çš„GitHubä»“åº“

3. **é…ç½®æœåŠ¡**
   - **Name**: `smart-news-backend`
   - **Region**: é€‰æ‹© Singapore (ç¦»å›½å†…æœ€è¿‘)
   - **Branch**: `main` æˆ– `master`
   - **Root Directory**: `backend`
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `python app.py`

4. **ç¯å¢ƒå˜é‡é…ç½®**
   åœ¨ "Environment" éƒ¨åˆ†æ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š
   ```
   COZE_WORKLOAD_IDENTITY_API_KEY=your_api_key_here
   COZE_INTEGRATION_MODEL_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
   PORT=5000
   DEBUG=False
   HOST=0.0.0.0
   ```

   **è·å–API Key**ï¼š
   - ç™»å½•Cozeå¹³å°
   - è¿›å…¥é¡¹ç›®è®¾ç½®
   - å¤åˆ¶API Key

5. **éƒ¨ç½²**
   - ç‚¹å‡» "Create Web Service"
   - ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦2-5åˆ†é’Ÿï¼‰
   - éƒ¨ç½²æˆåŠŸåï¼ŒRenderä¼šæä¾›ä¸€ä¸ªURLï¼Œä¾‹å¦‚ï¼š`https://smart-news-backend.onrender.com`

6. **æµ‹è¯•æœåŠ¡**
   ```bash
   curl https://smart-news-backend.onrender.com/health
   ```

   åº”è¯¥è¿”å›ï¼š
   ```json
   {"status":"healthy","message":"APIä»£ç†æœåŠ¡è¿è¡Œæ­£å¸¸"}
   ```

#### æ³¨æ„äº‹é¡¹ï¼š

- Renderå…è´¹ç‰ˆæœ‰15åˆ†é’Ÿæ— æ´»åŠ¨åä¼šä¼‘çœ ï¼Œé¦–æ¬¡è¯·æ±‚éœ€è¦çº¦30ç§’å”¤é†’
- å»ºè®®ä½¿ç”¨Renderçš„è‡ªåŠ¨ä¼‘çœ ä¿æ´»æœåŠ¡ï¼ˆå¦‚uptimerobot.comï¼‰å®šæœŸpingæœåŠ¡

---

### æ–¹æ¡ˆ2ï¼šRailwayï¼ˆå…è´¹é¢åº¦ï¼‰

Railwayæä¾›5ç¾å…ƒ/æœˆçš„å…è´¹é¢åº¦ï¼Œä¹Ÿé€‚åˆéƒ¨ç½²ã€‚

#### æ­¥éª¤ï¼š

1. **åˆ›å»ºRailwayè´¦å·**
   - è®¿é—® https://railway.app
   - æ³¨å†Œå¹¶ç™»å½•

2. **åˆ›å»ºæ–°é¡¹ç›®**
   - ç‚¹å‡» "New Project"
   - ç‚¹å‡» "Deploy from GitHub repo"
   - é€‰æ‹©ä½ çš„ä»“åº“

3. **é…ç½®æœåŠ¡**
   - Railwayä¼šè‡ªåŠ¨æ£€æµ‹Pythonåº”ç”¨
   - è¿›å…¥é¡¹ç›®è®¾ç½®ï¼Œä¿®æ”¹ "Root Directory" ä¸º `backend`

4. **ç¯å¢ƒå˜é‡**
   åœ¨ "Variables" æ ‡ç­¾é¡µæ·»åŠ ï¼š
   ```
   COZE_WORKLOAD_IDENTITY_API_KEY=your_api_key_here
   COZE_INTEGRATION_MODEL_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
   PORT=5000
   DEBUG=False
   HOST=0.0.0.0
   ```

5. **éƒ¨ç½²**
   - Railwayä¼šè‡ªåŠ¨éƒ¨ç½²
   - è·å¾—ä¸€ä¸ªRailway URLï¼Œä¾‹å¦‚ï¼š`https://smart-news-backend.up.railway.app`

---

### æ–¹æ¡ˆ3ï¼šæœ¬åœ°è¿è¡Œï¼ˆç”¨äºæµ‹è¯•ï¼‰

å¦‚æœä½ æƒ³å…ˆåœ¨æœ¬åœ°æµ‹è¯•ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ï¼š

#### æ­¥éª¤ï¼š

1. **å®‰è£…ä¾èµ–**
   ```bash
   cd backend
   pip install -r requirements.txt
   ```

2. **è®¾ç½®ç¯å¢ƒå˜é‡**
   ```bash
   export COZE_WORKLOAD_IDENTITY_API_KEY=your_api_key_here
   export COZE_INTEGRATION_MODEL_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
   export PORT=5000
   export DEBUG=True
   ```

   Windowsç”¨æˆ·ä½¿ç”¨ï¼š
   ```cmd
   set COZE_WORKLOAD_IDENTITY_API_KEY=your_api_key_here
   set COZE_INTEGRATION_MODEL_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
   set PORT=5000
   set DEBUG=True
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   python app.py
   ```

4. **æµ‹è¯•æœåŠ¡**
   - æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:5000/health`
   - åº”è¯¥çœ‹åˆ°ï¼š`{"status":"healthy","message":"APIä»£ç†æœåŠ¡è¿è¡Œæ­£å¸¸"}`

5. **ä½¿ç”¨ngrokæš´éœ²åˆ°å…¬ç½‘**ï¼ˆå¯é€‰ï¼‰
   å¦‚æœä½ éœ€è¦åˆ†äº«ç»™å…¶ä»–äººæµ‹è¯•ï¼š
   ```bash
   # å®‰è£…ngrok
   brew install ngrok  # Mac
   choco install ngrok  # Windows

   # å¯åŠ¨ngrok
   ngrok http 5000
   ```

   ngrokä¼šæä¾›ä¸€ä¸ªå…¬ç½‘URLï¼Œä¾‹å¦‚ï¼š`https://abc123.ngrok.io`

---

## å‰ç«¯é…ç½®

éƒ¨ç½²å®Œåç«¯æœåŠ¡åï¼Œéœ€è¦ä¿®æ”¹HTMLæ–‡ä»¶ä¸­çš„API URLã€‚

### ä¿®æ”¹æ­¥éª¤ï¼š

1. æ‰“å¼€ `æ™ºèƒ½æ–°é—»åŠ©æ‰‹-ä½œä¸šç‰ˆ.html`

2. æ‰¾åˆ°ç¬¬595è¡Œå·¦å³çš„ `API_URL` å¸¸é‡ï¼š
   ```javascript
   const API_URL = 'https://3dpp648g82.coze.site/stream_run';
   ```

3. æ›¿æ¢ä¸ºä½ çš„åç«¯APIåœ°å€ï¼š
   ```javascript
   const API_URL = 'https://your-backend-url.onrender.com/api/chat/stream';
   ```

   ä¾‹å¦‚ï¼š
   ```javascript
   const API_URL = 'https://smart-news-backend.onrender.com/api/chat/stream';
   ```

4. åˆ é™¤æˆ–æ³¨é‡Šæ‰ `PROJECT_ID` å¸¸é‡ï¼ˆä¸å†éœ€è¦ï¼‰ï¼š
   ```javascript
   // const PROJECT_ID = 7592888562761236495;
   ```

5. ä¿®æ”¹è¯·æ±‚æ ¼å¼ï¼Œæ‰¾åˆ°sendMessageå‡½æ•°ä¸­çš„fetchè°ƒç”¨ï¼š

   **æ—§ä»£ç **ï¼š
   ```javascript
   const response = await fetch(API_URL, {
       method: 'POST',
       headers: {
           'Authorization': `Bearer ${token}`,
           'Content-Type': 'application/json'
       },
       body: JSON.stringify({
           content: {
               query: {
                   prompt: [{
                       type: 'text',
                       content: {
                           text: userInput
                       }
                   }]
               }
           },
           type: 'query',
           project_id: PROJECT_ID
       })
   });
   ```

   **æ–°ä»£ç **ï¼š
   ```javascript
   const response = await fetch(API_URL, {
       method: 'POST',
       headers: {
           'Content-Type': 'application/json'
       },
       body: JSON.stringify({
           message: userInput,
           session_id: 'user-session'
       })
   });
   ```

6. ä¿®æ”¹æµå¼å“åº”è§£æé€»è¾‘ï¼š

   **æ—§ä»£ç **ï¼š
   ```javascript
   const reader = response.body.getReader();
   const decoder = new TextDecoder();
   let assistantMessage = '';
   let assistantId = null;

   while (true) {
       const { done, value } = await reader.read();
       if (done) break;

       const chunk = decoder.decode(value);
       const lines = chunk.split('\n');

       for (const line of lines) {
           if (line.startsWith('data: ')) {
               const data = JSON.parse(line.substring(6));
               if (data.content && data.content.answer) {
                   if (!assistantId) {
                       removeMessage(loadingId);
                       assistantId = addMessage('', 'assistant');
                   }
                   const delta = data.content.answer.delta;
                   if (delta) {
                       assistantMessage += delta;
                       updateMessage(assistantId, assistantMessage);
                   }
               }
           }
       }
   }
   ```

   **æ–°ä»£ç **ï¼š
   ```javascript
   const reader = response.body.getReader();
   const decoder = new TextDecoder();
   let assistantMessage = '';
   let assistantId = null;

   while (true) {
       const { done, value } = await reader.read();
       if (done) break;

       const chunk = decoder.decode(value);
       const lines = chunk.split('\n');

       for (const line of lines) {
           if (line.startsWith('data: ')) {
               const dataStr = line.substring(6);
               if (dataStr === '[DONE]') continue;
               try {
                   const data = JSON.parse(dataStr);
                   if (data.content) {
                       if (!assistantId) {
                           removeMessage(loadingId);
                           assistantId = addMessage('', 'assistant');
                       }
                       assistantMessage += data.content;
                       updateMessage(assistantId, assistantMessage);
                   }
               } catch (e) {
                   console.error('Parse error:', e);
               }
           }
       }
   }
   ```

---

## APIæ¥å£æ–‡æ¡£

### 1. å¥åº·æ£€æŸ¥

**è¯·æ±‚**ï¼š
```
GET /health
```

**å“åº”**ï¼š
```json
{
  "status": "healthy",
  "message": "APIä»£ç†æœåŠ¡è¿è¡Œæ­£å¸¸"
}
```

---

### 2. éæµå¼èŠå¤©

**è¯·æ±‚**ï¼š
```
POST /api/chat
Content-Type: application/json

{
  "message": "æ¨èä»Šæ—¥æ–°é—»",
  "session_id": "user-session-123"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "response": "AIå›å¤å†…å®¹"
}
```

---

### 3. æµå¼èŠå¤©ï¼ˆæ¨èï¼‰

**è¯·æ±‚**ï¼š
```
POST /api/chat/stream
Content-Type: application/json

{
  "message": "æ¨èä»Šæ—¥æ–°é—»",
  "session_id": "user-session-123"
}
```

**å“åº”**ï¼š
```
data: {"content":"ğŸ“° "}

data: {"content":"ä»Šæ—¥"}

data: {"content":"å¤´æ¡"}

data: {"content":"æ–°é—»"}

data: [DONE]
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šéƒ¨ç½²å¤±è´¥

**ç—‡çŠ¶**ï¼šRender/Railwayéƒ¨ç½²æ—¶å‡ºç°é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `requirements.txt` æ–‡ä»¶æ˜¯å¦åœ¨ `backend/` ç›®å½•ä¸‹
- æ£€æŸ¥ `app.py` æ–‡ä»¶æ˜¯å¦åœ¨ `backend/` ç›®å½•ä¸‹
- ç¡®ä¿é¡¹ç›®å·²æ¨é€åˆ°GitHub

---

### é—®é¢˜2ï¼š502 Bad Gateway

**ç—‡çŠ¶**ï¼šè®¿é—®åç«¯APIæ—¶è¿”å›502é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æœåŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨ï¼ˆæŸ¥çœ‹Render/Railwayæ—¥å¿—ï¼‰
- æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
- ç¡®ä¿ç«¯å£è®¾ç½®ä¸º5000

---

### é—®é¢˜3ï¼šCORSé”™è¯¯ï¼ˆå‰ç«¯ï¼‰

**ç—‡çŠ¶**ï¼šæµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºCORSé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿åç«¯æœåŠ¡å·²æ­£ç¡®éƒ¨ç½²å¹¶å¯è®¿é—®
- æ£€æŸ¥å‰ç«¯ä»£ç ä¸­çš„API_URLæ˜¯å¦æ­£ç¡®
- ä½¿ç”¨ `curl` æµ‹è¯•åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼š
  ```bash
  curl https://your-backend-url.onrender.com/health
  ```

---

### é—®é¢˜4ï¼šæœåŠ¡ä¼‘çœ ï¼ˆRenderå…è´¹ç‰ˆï¼‰

**ç—‡çŠ¶**ï¼šé¦–æ¬¡è¯·æ±‚å¾ˆæ…¢ï¼ˆçº¦30ç§’ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¿™æ˜¯Renderå…è´¹ç‰ˆçš„æ­£å¸¸è¡Œä¸º
- ä½¿ç”¨ä¿æ´»æœåŠ¡å®šæœŸpingï¼š
  1. è®¿é—® https://uptimerobot.com
  2. åˆ›å»ºä¸€ä¸ªMonitor
  3. è¾“å…¥ä½ çš„åç«¯APIåœ°å€
  4. è®¾ç½®æ¯5åˆ†é’Ÿpingä¸€æ¬¡

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥Render/Railwayçš„æ—¥å¿—
2. æµ‹è¯•åç«¯æœåŠ¡çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
3. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
4. ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½®

---

## ä¸‹ä¸€æ­¥

1. éƒ¨ç½²åç«¯æœåŠ¡åˆ°Renderæˆ–Railway
2. è·å–åç«¯API URL
3. ä¿®æ”¹HTMLæ–‡ä»¶ä¸­çš„API URL
4. å°†HTMLéƒ¨ç½²åˆ°GitHub Pagesæˆ–å…¶ä»–é™æ€æ‰˜ç®¡å¹³å°
5. æµ‹è¯•å®Œæ•´æµç¨‹

---

**ç¥ä½ éƒ¨ç½²é¡ºåˆ©ï¼** ğŸš€
